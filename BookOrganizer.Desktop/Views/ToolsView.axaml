<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:BookOrganizer.Desktop.ViewModels"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
             x:Class="BookOrganizer.Desktop.Views.ToolsView"
             x:DataType="vm:ToolsViewModel">

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!-- Library path (shared) -->
        <Border Grid.Row="0" Padding="12,8" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="Auto,*">
                <TextBlock Grid.Column="0" Text="Library:" VerticalAlignment="Center" Margin="0,0,8,0" />
                <TextBox Grid.Column="1" Text="{Binding LibraryPath}" Watermark="Path to audiobook library..." />
            </Grid>
        </Border>

        <!-- Tab selector -->
        <TabControl Grid.Row="1" Grid.RowSpan="2" SelectedIndex="{Binding SelectedTabIndex}" Margin="8">

            <!-- Reorganize tab -->
            <TabItem Header="Reorganize">
                <StackPanel Spacing="12" Margin="16" MaxWidth="500">
                    <TextBlock Text="Reorganize Library" FontSize="18" FontWeight="Bold" />
                    <TextBlock TextWrapping="Wrap"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                        Reorganizes the library folder structure based on updated bookinfo.json metadata.
                        Books will be moved to match their Author/Series/Title metadata.
                    </TextBlock>

                    <ProgressBar Value="{Binding ProgressPercent}" Maximum="100" Height="16"
                                 IsVisible="{Binding IsBusy}" />

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Reorganize" Command="{Binding ReorganizeCommand}"
                                IsEnabled="{Binding !IsBusy}" Classes="accent" />
                        <Button Content="Cancel" Command="{Binding ReorganizeCancelCommand}"
                                IsEnabled="{Binding IsBusy}" />
                    </StackPanel>
                </StackPanel>
            </TabItem>

            <!-- Export Metadata tab -->
            <TabItem Header="Export Metadata">
                <StackPanel Spacing="12" Margin="16" MaxWidth="500">
                    <TextBlock Text="Export Metadata" FontSize="18" FontWeight="Bold" />
                    <TextBlock TextWrapping="Wrap"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                        Generates metadata files (bookinfo.json) from folder structure for audiobooks
                        that don't have them yet.
                    </TextBlock>

                    <TextBlock Text="Source path (defaults to library):" FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBox Text="{Binding MetadataSourcePath}" Watermark="Optional: override source path..." />

                    <CheckBox Content="Force overwrite existing metadata" IsChecked="{Binding ExportForce}" />

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Export" Command="{Binding ExportMetadataCommand}"
                                IsEnabled="{Binding !IsBusy}" Classes="accent" />
                        <Button Content="Cancel" Command="{Binding ExportMetadataCancelCommand}"
                                IsEnabled="{Binding IsBusy}" />
                    </StackPanel>
                </StackPanel>
            </TabItem>

            <!-- Verify tab -->
            <TabItem Header="Verify">
                <Grid RowDefinitions="Auto,*">
                    <StackPanel Grid.Row="0" Spacing="8" Margin="16,16,16,8">
                        <TextBlock Text="Verify Library" FontSize="18" FontWeight="Bold" />
                        <TextBlock TextWrapping="Wrap"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                            Checks library integrity: missing metadata files, empty folders, and other issues.
                        </TextBlock>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="Verify" Command="{Binding VerifyCommand}"
                                    IsEnabled="{Binding !IsBusy}" Classes="accent" />
                            <Button Content="Cancel" Command="{Binding VerifyCancelCommand}"
                                    IsEnabled="{Binding IsBusy}" />
                        </StackPanel>
                    </StackPanel>

                    <DataGrid Grid.Row="1" ItemsSource="{Binding VerifyResults}" IsReadOnly="True"
                              Margin="8" GridLinesVisibility="Horizontal" AutoGenerateColumns="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Severity" Binding="{Binding Severity}" Width="80" />
                            <DataGridTextColumn Header="Path" Binding="{Binding Path}" Width="*" />
                            <DataGridTextColumn Header="Message" Binding="{Binding Message}" Width="250" />
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>

            <!-- Audiobookshelf tab -->
            <TabItem Header="Audiobookshelf">
                <ScrollViewer>
                <StackPanel Spacing="12" Margin="16" MaxWidth="500">
                    <TextBlock Text="Audiobookshelf Settings" FontSize="18" FontWeight="Bold" />
                    <TextBlock TextWrapping="Wrap"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                        Configure connection to your Audiobookshelf server for publishing audiobooks.
                    </TextBlock>

                    <TextBlock Text="Server URL" FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBox Text="{Binding AbsServerUrl}" Watermark="https://abs.example.com" />

                    <TextBlock Text="API Key" FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBox Text="{Binding AbsApiKey}" PasswordChar="*"
                             Watermark="Enter API key..." />

                    <TextBlock Text="ABS Library Folder (local mount)" FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    <TextBox Text="{Binding AbsLibraryFolder}"
                             Watermark="/mnt/abs-library or /Volumes/abs-library" />

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Test Connection" Command="{Binding TestAbsConnectionCommand}"
                                IsEnabled="{Binding !IsBusy}" />
                        <Button Content="Save" Command="{Binding SaveAbsSettingsCommand}"
                                Classes="accent" />
                    </StackPanel>

                    <TextBlock Text="{Binding AbsConnectionStatus}" FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                               TextWrapping="Wrap" />

                    <TextBlock Text="Library" FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                               Margin="0,8,0,0" />
                    <ComboBox ItemsSource="{Binding AbsLibraries}"
                              SelectedValue="{Binding SelectedAbsLibraryId}"
                              SelectedValueBinding="{Binding Id}"
                              DisplayMemberBinding="{Binding}"
                              HorizontalAlignment="Stretch" />
                </StackPanel>
                </ScrollViewer>
            </TabItem>

        </TabControl>

        <!-- Status bar -->
        <Border Grid.Row="3" Padding="12,4" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="0,1,0,0">
            <TextBlock Text="{Binding StatusText}" FontSize="12"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
        </Border>
    </Grid>

</UserControl>
