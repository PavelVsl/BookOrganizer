<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:BookOrganizer.Desktop.ViewModels"
             xmlns:views="using:BookOrganizer.Desktop.Views"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
             x:Class="BookOrganizer.Desktop.Views.LibraryView"
             x:DataType="vm:LibraryViewModel">

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!-- Header: library path + browse + load button -->
        <Border Grid.Row="0" Padding="12,8" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                <TextBlock Grid.Column="0" Text="Library:" VerticalAlignment="Center" Margin="0,0,8,0" />
                <TextBox Grid.Column="1" Text="{Binding LibraryPath}" Watermark="Path to audiobook library..."
                         Margin="0,0,4,0" />
                <Button Grid.Column="2" Content="..." Command="{Binding BrowseLibraryCommand}"
                        ToolTip.Tip="Browse for folder" Width="32" Margin="0,0,4,0" />
                <Button Grid.Column="3" Content="Load" Command="{Binding LoadLibraryCommand}"
                        IsEnabled="{Binding !IsLoading}" />
            </Grid>
        </Border>

        <!-- Toolbar -->
        <Border Grid.Row="1" Padding="8,4" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <Button Content="Scan Metadata" Command="{Binding ScanMetadataCommand}"
                        IsEnabled="{Binding !IsLoading}" ToolTip.Tip="Run full metadata extraction (MP3 tags + bookinfo.json + folder structure)" />
                <Button Content="Export NFO" Command="{Binding ExportNfoCommand}"
                        IsEnabled="{Binding !IsLoading}"
                        ToolTip.Tip="Regenerate metadata.nfo for all books" />
                <Button Content="Synonyms" Command="{Binding DetectSynonymsCommand}"
                        ToolTip.Tip="Detect similar author/narrator names" />
                <Separator Width="1" Margin="4,2" />
                <ToggleButton IsChecked="{Binding FilterMisplacedOnly}"
                              ToolTip.Tip="Show only books that need reorganization">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="&#10132;" Foreground="Gold" />
                        <TextBlock Text="{Binding MisplacedCount}" />
                    </StackPanel>
                </ToggleButton>
                <ToggleButton IsChecked="{Binding HidePublished}"
                              ToolTip.Tip="Hide already-published books"
                              Content="Hide published" />
                <Separator Width="1" Margin="4,2" />
                <ComboBox SelectedIndex="{Binding ReorganizeModeIndex}" Width="120">
                    <ComboBoxItem Content="In-place" />
                    <ComboBoxItem Content="Copy to..." />
                    <ComboBoxItem Content="Move to..." />
                </ComboBox>
                <TextBox Text="{Binding DestinationPath}" Watermark="Destination path..."
                         Width="200" IsVisible="{Binding NeedsDestination}" />
                <Button Content="..." Command="{Binding BrowseDestinationCommand}"
                        ToolTip.Tip="Browse for destination folder" Width="32"
                        IsVisible="{Binding NeedsDestination}" />
                <Button Content="Reorganize" Command="{Binding ReorganizeCommand}"
                        IsEnabled="{Binding !IsReorganizing}"
                        ToolTip.Tip="Organize books into Author/Series/Title structure" />
            </StackPanel>
        </Border>

        <!-- Main content -->
        <Grid Grid.Row="2">
            <!-- Synonym panel (shown when detected) -->
            <Panel IsVisible="{Binding ShowSynonymPanel}">
                <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                        Padding="12" CornerRadius="4" Margin="8">
                    <Grid RowDefinitions="Auto,*,Auto">
                        <TextBlock Grid.Row="0" Text="Synonym Groups" FontSize="16" FontWeight="Bold" Margin="0,0,0,8" />

                        <ScrollViewer Grid.Row="1">
                            <ItemsControl ItemsSource="{Binding SynonymGroups}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="vm:NameSynonymGroup">
                                        <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                                                BorderThickness="1" CornerRadius="4" Padding="8" Margin="0,0,0,8">
                                            <StackPanel Spacing="4">
                                                <TextBlock Text="{Binding FieldName}" FontWeight="SemiBold" />
                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                    <TextBlock Text="Canonical:" VerticalAlignment="Center" />
                                                    <TextBox Text="{Binding CanonicalName}" Width="250" />
                                                </StackPanel>
                                                <ItemsControl ItemsSource="{Binding Variants}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate DataType="vm:NameVariant">
                                                            <TextBlock Margin="16,0,0,0">
                                                                <Run Text="{Binding Name}" />
                                                                <Run Text="{Binding BookCount, StringFormat=' ({0} books)'}"
                                                                     Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            </TextBlock>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                            <Button Content="Apply" Command="{Binding ApplySynonymsCommand}" Classes="accent" />
                            <Button Content="Cancel" Command="{Binding DetectSynonymsCommand}" />
                        </StackPanel>
                    </Grid>
                </Border>
            </Panel>

            <!-- Main library view (hidden when synonyms shown) -->
            <Panel IsVisible="{Binding !ShowSynonymPanel}">
                <TabControl>
                    <!-- Tree view tab -->
                    <TabItem Header="Tree">
                        <Grid ColumnDefinitions="350,Auto,*">
                            <!-- Tree browser -->
                            <TreeView Grid.Column="0" ItemsSource="{Binding Authors}"
                                      SelectedItem="{Binding SelectedItem}"
                                      Margin="4">
                                <TreeView.DataTemplates>
                                    <TreeDataTemplate DataType="vm:AuthorNode" ItemsSource="{Binding Children}">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="&#128100;" />
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                        </StackPanel>
                                    </TreeDataTemplate>
                                    <TreeDataTemplate DataType="vm:SeriesNode" ItemsSource="{Binding Books}">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="&#128218;" />
                                            <TextBlock Text="{Binding Name}" FontStyle="Italic" />
                                        </StackPanel>
                                    </TreeDataTemplate>
                                    <TreeDataTemplate DataType="vm:BookNode" ItemsSource="{Binding Volumes}">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="&#127911;" />
                                            <TextBlock Text="{Binding SeriesNumber, StringFormat='{}{0} - '}"
                                                       IsVisible="{Binding SeriesNumber, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                            <TextBlock Text="{Binding Title}" />
                                            <TextBlock Text="&#10004;" Foreground="Green" FontSize="12"
                                                       IsVisible="{Binding IsPublished}"
                                                       ToolTip.Tip="Published to Audiobookshelf"
                                                       VerticalAlignment="Center" />
                                            <TextBlock Text="&#10132;" Foreground="Gold" FontSize="12"
                                                       IsVisible="{Binding NeedsReorganize}"
                                                       ToolTip.Tip="{Binding ExpectedPath, StringFormat='Needs move to: {0}'}"
                                                       VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding DiscCount, StringFormat='({0} discs)'}"
                                                       IsVisible="{Binding IsMultiDisc}"
                                                       Foreground="Orange"
                                                       FontSize="11" VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding AudioFileCount, StringFormat='({0} files)'}"
                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                       FontSize="11" VerticalAlignment="Center" />
                                        </StackPanel>
                                    </TreeDataTemplate>
                                    <DataTemplate DataType="vm:VolumeNode">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <TextBlock Text="&#128191;" />
                                            <TextBlock Text="{Binding Name}" />
                                            <TextBlock Text="{Binding FileCount, StringFormat='({0} files)'}"
                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                       FontSize="11" VerticalAlignment="Center" />
                                        </StackPanel>
                                    </DataTemplate>
                                </TreeView.DataTemplates>
                            </TreeView>

                            <GridSplitter Grid.Column="1" Width="4" ResizeDirection="Columns"
                                          Background="{DynamicResource SystemControlForegroundBaseLowBrush}" />

                            <!-- Detail panel -->
                            <ContentControl Grid.Column="2" Content="{Binding SelectedDetail}" Margin="8,4">
                                <ContentControl.DataTemplates>

                                        <!-- Author detail -->
                                        <DataTemplate DataType="vm:AuthorDetailViewModel">
                                            <ScrollViewer>
                                            <StackPanel Spacing="8" MaxWidth="500" Margin="8">
                                                <TextBlock Text="Author" FontSize="18" FontWeight="Bold" Margin="0,0,0,8" />
                                                <TextBlock Text="Author name" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <TextBox Grid.Column="0" Text="{Binding AuthorName}" />
                                                    <Button Grid.Column="1" Content="&#8644;" Command="{Binding SwapNameCommand}"
                                                            ToolTip.Tip="Swap firstname and surname"
                                                            Padding="8,4" Margin="4,0,0,0" />
                                                </Grid>
                                                <Separator Margin="0,8" />
                                                <TextBlock Text="{Binding BookCount, StringFormat='{}{0} book(s)'}" FontSize="12" />
                                                <TextBlock Text="{Binding SeriesCount, StringFormat='{}{0} series'}" FontSize="12"
                                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                <TextBlock Text="{Binding FolderPath}" FontSize="11"
                                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                           TextWrapping="Wrap" Margin="0,4,0,0" />
                                                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                                                    <Button Content="Save" Command="{Binding SaveCommand}"
                                                            IsEnabled="{Binding IsDirty}" Classes="accent" />
                                                    <Button Content="Revert" Command="{Binding RevertCommand}"
                                                            IsEnabled="{Binding IsDirty}" />
                                                </StackPanel>
                                                <TextBlock Text="{Binding SaveStatus}" FontSize="11"
                                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />

                                                <!-- Publish section -->
                                                <StackPanel IsVisible="{Binding CanPublish}"
                                                            Margin="0,12,0,0">
                                                    <Separator Margin="0,0,0,8" />
                                                    <TextBlock Text="{Binding UnpublishedCount, StringFormat='{}{0} book(s) not published'}"
                                                               FontSize="12" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                    <Button Content="Publish all to ABS" Command="{Binding PublishAllCommand}"
                                                            Margin="0,4,0,0"
                                                            ToolTip.Tip="Publish all unpublished books to Audiobookshelf" />
                                                    <TextBlock Text="{Binding PublishStatus}" FontSize="11"
                                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                               IsVisible="{Binding PublishStatus, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                                </StackPanel>

                                                <!-- Reorganize section -->
                                                <StackPanel IsVisible="{Binding HasBooksNeedingReorganize}"
                                                            Margin="0,12,0,0">
                                                    <Separator Margin="0,0,0,8" />
                                                    <TextBlock Text="{Binding BooksNeedingReorganize, StringFormat='{}{0} book(s) need reorganization'}"
                                                               FontSize="12" Foreground="Gold" />
                                                    <Button Content="Reorganize all" Command="{Binding ReorganizeAuthorCommand}"
                                                            Margin="0,4,0,0" />
                                                </StackPanel>
                                            </StackPanel>
                                            </ScrollViewer>
                                        </DataTemplate>

                                        <!-- Series detail -->
                                        <DataTemplate DataType="vm:SeriesDetailViewModel">
                                            <ScrollViewer>
                                            <StackPanel Spacing="8" MaxWidth="500" Margin="8">
                                                <TextBlock Text="Series" FontSize="18" FontWeight="Bold" Margin="0,0,0,8" />
                                                <TextBlock Text="Series name" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                <TextBox Text="{Binding SeriesName}" />
                                                <Separator Margin="0,8" />
                                                <TextBlock Text="{Binding BookCount, StringFormat='{}{0} book(s) in series'}" FontSize="12" />
                                                <TextBlock Text="{Binding FolderPath}" FontSize="11"
                                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                           TextWrapping="Wrap" Margin="0,4,0,0" />
                                                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                                                    <Button Content="Save" Command="{Binding SaveCommand}"
                                                            IsEnabled="{Binding IsDirty}" Classes="accent" />
                                                    <Button Content="Revert" Command="{Binding RevertCommand}"
                                                            IsEnabled="{Binding IsDirty}" />
                                                </StackPanel>
                                                <TextBlock Text="{Binding SaveStatus}" FontSize="11"
                                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />

                                                <!-- Publish section -->
                                                <StackPanel IsVisible="{Binding CanPublish}"
                                                            Margin="0,12,0,0">
                                                    <Separator Margin="0,0,0,8" />
                                                    <TextBlock Text="{Binding UnpublishedCount, StringFormat='{}{0} book(s) not published'}"
                                                               FontSize="12" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                    <Button Content="Publish all to ABS" Command="{Binding PublishAllCommand}"
                                                            Margin="0,4,0,0"
                                                            ToolTip.Tip="Publish all unpublished books in series to Audiobookshelf" />
                                                    <TextBlock Text="{Binding PublishStatus}" FontSize="11"
                                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                               IsVisible="{Binding PublishStatus, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                                </StackPanel>
                                            </StackPanel>
                                            </ScrollViewer>
                                        </DataTemplate>

                                        <!-- Book detail (tabbed: Edit / MP3 Tags / bookinfo.json / metadata.nfo) -->
                                        <DataTemplate DataType="vm:BookDetailViewModel">
                                            <Grid ColumnDefinitions="Auto,*">
                                            <!-- Cover image panel -->
                                            <StackPanel Grid.Column="0" Width="200" Margin="8"
                                                        IsVisible="{Binding CoverImage, Converter={x:Static ObjectConverters.IsNotNull}}">
                                                <Image Source="{Binding CoverImage}"
                                                       MaxWidth="200" MaxHeight="280"
                                                       Stretch="Uniform" />
                                                <TextBlock Text="{Binding CoverImageSource}"
                                                           FontSize="10" HorizontalAlignment="Center"
                                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                           Margin="0,4,0,0" />
                                            </StackPanel>
                                            <TabControl Grid.Column="1">
                                                <!-- Edit tab -->
                                                <TabItem Header="Edit">
                                                    <ScrollViewer>
                                                        <StackPanel Spacing="8" MaxWidth="500" Margin="8">
                                                            <TextBlock Text="Author" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <Grid ColumnDefinitions="*,Auto">
                                                                <TextBox Grid.Column="0" Text="{Binding Author}" />
                                                                <Button Grid.Column="1" Content="&#8644;" Command="{Binding SwapAuthorNameCommand}"
                                                                        ToolTip.Tip="Swap firstname and surname"
                                                                        Padding="8,4" Margin="4,0,0,0" />
                                                            </Grid>

                                                            <TextBlock Text="Title" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <TextBox Text="{Binding Title}" />

                                                            <TextBlock Text="Series" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <TextBox Text="{Binding Series}" />

                                                            <TextBlock Text="Series #" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <TextBox Text="{Binding SeriesNumber}" />

                                                            <TextBlock Text="Disc #" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <TextBox Text="{Binding DiscNumber}" />

                                                            <TextBlock Text="Narrator" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <TextBox Text="{Binding Narrator}" />

                                                            <TextBlock Text="Year" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <TextBox Text="{Binding Year}" />

                                                            <TextBlock Text="Genre" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <TextBox Text="{Binding Genre}" />

                                                            <TextBlock Text="Publisher" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <TextBox Text="{Binding Publisher}" />

                                                            <TextBlock Text="Language" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <TextBox Text="{Binding Language}" />

                                                            <TextBlock Text="Description" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <TextBox Text="{Binding Description}" AcceptsReturn="True" MinHeight="60"
                                                                     TextWrapping="Wrap" />

                                                            <Separator Margin="0,8" />

                                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                                <TextBlock Text="{Binding FolderPath}" FontSize="11"
                                                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                                           TextWrapping="Wrap" VerticalAlignment="Center" />
                                                                <Button Content="Open" Command="{Binding OpenInFinderCommand}"
                                                                        FontSize="11" Padding="6,2"
                                                                        ToolTip.Tip="Open folder in Finder" />
                                                            </StackPanel>
                                                            <TextBlock Text="{Binding AudioFileCount, StringFormat='{}{0} audio file(s)'}"
                                                                       FontSize="11"
                                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />

                                                            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                                                                <Button Content="Save" Command="{Binding SaveCommand}"
                                                                        IsEnabled="{Binding IsDirty}" Classes="accent" />
                                                                <Button Content="Revert" Command="{Binding RevertCommand}"
                                                                        IsEnabled="{Binding IsDirty}" />
                                                                <Button Content="Publish to ABS" Command="{Binding PublishCommand}"
                                                                        IsEnabled="{Binding CanPublish}"
                                                                        ToolTip.Tip="Copy book to Audiobookshelf library folder" />
                                                                <Button Content="Delete" Command="{Binding DeleteBookCommand}"
                                                                        Foreground="Red"
                                                                        ToolTip.Tip="Move book folder to .trash" />
                                                            </StackPanel>
                                                            <TextBlock Text="{Binding SaveStatus}" FontSize="11"
                                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                            <TextBlock Text="{Binding PublishStatus}" FontSize="11"
                                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                                       IsVisible="{Binding PublishStatus, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />

                                                            <!-- Reorganize section -->
                                                            <StackPanel IsVisible="{Binding NeedsReorganize}" Margin="0,12,0,0">
                                                                <Separator Margin="0,0,0,8" />
                                                                <TextBlock Text="Target:" FontSize="11"
                                                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                                <TextBlock Text="{Binding ExpectedPath}" FontSize="11"
                                                                           TextWrapping="Wrap" Foreground="Gold" Margin="0,2,0,4" />
                                                                <Button Content="Move to correct path"
                                                                        Command="{Binding ReorganizeBookCommand}" />
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </ScrollViewer>
                                                </TabItem>

                                                <!-- MP3 Tags tab -->
                                                <TabItem Header="MP3 Tags">
                                                    <TextBox Text="{Binding Mp3TagsSummary, Mode=OneWay}"
                                                             IsReadOnly="True" AcceptsReturn="True"
                                                             TextWrapping="Wrap" Margin="8"
                                                             FontFamily="Consolas, Menlo, monospace"
                                                             FontSize="11" />
                                                </TabItem>

                                                <!-- bookinfo.json tab -->
                                                <TabItem Header="bookinfo.json">
                                                    <TextBox Text="{Binding BookinfoContent, Mode=OneWay}"
                                                             IsReadOnly="True" AcceptsReturn="True"
                                                             TextWrapping="Wrap" Margin="8"
                                                             FontFamily="Consolas, Menlo, monospace"
                                                             FontSize="11" />
                                                </TabItem>

                                                <!-- metadata.nfo tab -->
                                                <TabItem Header="metadata.nfo">
                                                    <TextBox Text="{Binding NfoContent, Mode=OneWay}"
                                                             IsReadOnly="True" AcceptsReturn="True"
                                                             TextWrapping="Wrap" Margin="8"
                                                             FontFamily="Consolas, Menlo, monospace"
                                                             FontSize="11" />
                                                </TabItem>

                                                <!-- Files tab -->
                                                <TabItem Header="Files">
                                                    <DataGrid ItemsSource="{Binding FolderFiles}"
                                                              IsReadOnly="True" CanUserSortColumns="True"
                                                              GridLinesVisibility="Horizontal"
                                                              Margin="8" FontSize="11">
                                                        <DataGrid.Columns>
                                                            <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*" />
                                                            <DataGridTextColumn Header="Size" Binding="{Binding Size}" Width="80" />
                                                        </DataGrid.Columns>
                                                    </DataGrid>
                                                </TabItem>
                                            </TabControl>
                                            </Grid>
                                        </DataTemplate>

                                        <!-- Volume (disc) detail -->
                                        <DataTemplate DataType="vm:VolumeDetailViewModel">
                                            <TabControl>
                                                <TabItem Header="Edit">
                                                    <ScrollViewer>
                                                    <StackPanel Spacing="8" MaxWidth="500" Margin="8">
                                                        <TextBlock Text="{Binding VolumeName}" FontSize="18" FontWeight="Bold" Margin="0,0,0,4" />

                                                        <TextBlock Text="Author" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                        <TextBox Text="{Binding Author}" />

                                                        <TextBlock Text="Title" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                        <TextBox Text="{Binding Title}" />

                                                        <TextBlock Text="Series" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                        <TextBox Text="{Binding Series}" />

                                                        <TextBlock Text="Series #" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                        <TextBox Text="{Binding SeriesNumber}" />

                                                        <TextBlock Text="Disc #" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                        <TextBox Text="{Binding DiscNumber}" />

                                                        <TextBlock Text="Narrator" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                        <TextBox Text="{Binding Narrator}" />

                                                        <TextBlock Text="Year" FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                        <TextBox Text="{Binding Year}" />

                                                        <Separator Margin="0,8" />

                                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                                            <TextBlock Text="{Binding FolderPath}" FontSize="11"
                                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                                       TextWrapping="Wrap" VerticalAlignment="Center" />
                                                            <Button Content="Open" Command="{Binding OpenInFinderCommand}"
                                                                    FontSize="11" Padding="6,2"
                                                                    ToolTip.Tip="Open folder in Finder" />
                                                        </StackPanel>
                                                        <TextBlock Text="{Binding FileCount, StringFormat='{}{0} file(s)'}" FontSize="11"
                                                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />

                                                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                                                            <Button Content="Save" Command="{Binding SaveCommand}"
                                                                    IsEnabled="{Binding IsDirty}" Classes="accent" />
                                                            <Button Content="Revert" Command="{Binding RevertCommand}"
                                                                    IsEnabled="{Binding IsDirty}" />
                                                        </StackPanel>
                                                        <TextBlock Text="{Binding SaveStatus}" FontSize="11"
                                                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                                    </StackPanel>
                                                    </ScrollViewer>
                                                </TabItem>

                                                <TabItem Header="bookinfo.json">
                                                    <TextBox Text="{Binding BookinfoContent, Mode=OneWay}"
                                                             IsReadOnly="True" AcceptsReturn="True"
                                                             TextWrapping="Wrap" Margin="8"
                                                             FontFamily="Consolas, Menlo, monospace"
                                                             FontSize="11" />
                                                </TabItem>

                                                <TabItem Header="Files">
                                                    <DataGrid ItemsSource="{Binding Files}"
                                                              IsReadOnly="True" CanUserSortColumns="True"
                                                              GridLinesVisibility="Horizontal"
                                                              Margin="8" FontSize="11">
                                                        <DataGrid.Columns>
                                                            <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*" />
                                                            <DataGridTextColumn Header="Size" Binding="{Binding Size}" Width="80" />
                                                        </DataGrid.Columns>
                                                    </DataGrid>
                                                </TabItem>
                                            </TabControl>
                                        </DataTemplate>

                                </ContentControl.DataTemplates>
                            </ContentControl>
                        </Grid>
                    </TabItem>

                    <!-- Grid view tab -->
                    <TabItem Header="Grid">
                        <views:LibraryGridView DataContext="{Binding}" />
                    </TabItem>
                </TabControl>
            </Panel>
        </Grid>

        <!-- Status bar -->
        <Border Grid.Row="3" Padding="12,4" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="0,1,0,0">
            <TextBlock Text="{Binding StatusText}" FontSize="12"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
        </Border>
    </Grid>

</UserControl>
